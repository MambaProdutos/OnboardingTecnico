<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador de Onboarding Técnico</title>
    <!-- Carrega o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Configuração de Cores (Lakers) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'lakers-purple': {
                            'DEFAULT': '#552583',
                            'dark': '#3a1a5c',
                            'darker': '#2c1345',
                        },
                        'lakers-gold': {
                            'DEFAULT': '#FDB927',
                            'light': '#ffca60',
                        },
                    },
                },
            },
        };
    </script>

    <!-- Estilos Globais e Animações de Modal -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #2c1345; /* lakers-purple-darker */
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            animation: fadeIn 0.3s ease-out;
        }

        /* Correção de Z-index: Garante que o modal de adicionar aluno (nível 2)
           apareça sobre o modal de ver turma (nível 1) */
        #add-student-modal {
            z-index: 60;
        }

        /* Nível 3 - OKRs do Aluno (Mais alto) */
        #student-okr-modal {
            z-index: 70;
        }
        
        .modal-content {
            animation: slideIn 0.3s ease-out;
            max-height: 90vh;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .tab-button.active {
            border-bottom-color: #FDB927; /* lakers-gold */
            color: #FDB927;
        }
        /* Scrollbar customizada */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #3a1a5c; /* lakers-purple-dark */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #FDB927; /* lakers-gold */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #ffca60; /* lakers-gold-light */
        }
    </style>
</head>
<body class="text-lakers-gold">

    <!-- Header -->
    <header class="bg-lakers-purple-dark shadow-lg p-6 flex justify-between items-center sticky top-0 z-40">
        <h1 class="text-3xl font-bold text-lakers-gold">Organizador de Onboarding</h1>
        <button id="show-create-class-modal" class="bg-lakers-gold text-lakers-purple-darker font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-lakers-gold-light transition duration-300 flex items-center space-x-2">
            <span class="font-bold text-xl mr-1">+</span>
            <span>Criar Nova Turma</span>
        </button>
    </header>

    <!-- Container Principal das Turmas -->
    <main id="classes-container" class="p-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Turmas serão injetadas aqui -->
    </main>

    <!-- Mensagem de "Nenhuma turma" -->
    <div id="no-classes-message" class="hidden text-center p-16">
        <h2 class="text-2xl font-semibold mt-4">Nenhuma turma encontrada</h2>
        <p class="text-lg text-gray-400">Clique em "Criar Nova Turma" para começar.</p>
    </div>

    <!-- Modal: Criar Nova Turma -->
    <div id="create-class-modal" class="modal">
        <div class="modal-content bg-lakers-purple-dark w-11/12 md:max-w-md m-auto mt-20 p-6 rounded-xl shadow-2xl border border-lakers-purple">
            <h2 class="text-2xl font-bold text-lakers-gold mb-6">Criar Nova Turma</h2>
            <label for="start-date" class="block text-sm font-medium mb-2">Selecione a data de início:</label>
            <input type="date" id="start-date" class="w-full p-3 rounded-lg bg-lakers-purple-darker border border-lakers-purple text-white focus:outline-none focus:ring-2 focus:ring-lakers-gold" />
            <div class="flex justify-end space-x-4 mt-8">
                <button id="cancel-create-class" class="py-2 px-5 rounded-lg bg-gray-600 text-white hover:bg-gray-500 transition">Cancelar</button>
                <button id="confirm-create-class" class="py-2 px-5 rounded-lg bg-lakers-gold text-lakers-purple-darker font-semibold hover:bg-lakers-gold-light transition">Criar Turma</button>
            </div>
        </div>
    </div>

    <!-- Modal: Adicionar Aluno -->
    <div id="add-student-modal" class="modal">
        <div class="modal-content bg-lakers-purple-dark w-11/12 md:max-w-md m-auto mt-20 p-6 rounded-xl shadow-2xl border border-lakers-purple">
            <h2 class="text-2xl font-bold text-lakers-gold mb-6">Adicionar Novo Aluno</h2>
            <input type="hidden" id="add-student-class-id">
            <div class="space-y-4">
                <div>
                    <label for="student-name" class="block text-sm font-medium mb-2">Nome do Aluno:</label>
                    <input type="text" id="student-name" placeholder="Ex: João da Silva" class="w-full p-3 rounded-lg bg-lakers-purple-darker border border-lakers-purple text-white focus:outline-none focus:ring-2 focus:ring-lakers-gold" />
                </div>
                <div>
                    <label for="student-role" class="block text-sm font-medium mb-2">Função:</label>
                    <input type="text" id="student-role" placeholder="Ex: Desenvolvedor Jr." class="w-full p-3 rounded-lg bg-lakers-purple-darker border border-lakers-purple text-white focus:outline-none focus:ring-2 focus:ring-lakers-gold" />
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-8">
                <button id="cancel-add-student" class="py-2 px-5 rounded-lg bg-gray-600 text-white hover:bg-gray-500 transition">Cancelar</button>
                <button id="confirm-add-student" class="py-2 px-5 rounded-lg bg-lakers-gold text-lakers-purple-darker font-semibold hover:bg-lakers-gold-light transition">Adicionar Aluno</button>
            </div>
        </div>
    </div>

    <!-- Modal: Ver Detalhes da Turma -->
    <div id="view-class-modal" class="modal">
        <div class="modal-content bg-lakers-purple-dark w-11/12 md:max-w-4xl lg:max-w-6xl m-auto mt-10 p-6 rounded-xl shadow-2xl border border-lakers-purple overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 id="view-class-title" class="text-3xl font-bold text-lakers-gold"></h2>
                    <p id="view-class-week" class_name="text-xl text-lakers-gold-light"></p>
                </div>
                <button id="close-view-class" class="text-gray-400 hover:text-white transition text-3xl font-bold">&times;</button>
            </div>
            
            <input type="hidden" id="view-class-id">

            <!-- Abas -->
            <div class="border-b border-lakers-purple mb-6">
                <nav class="flex space-x-8">
                    <button class="tab-button active text-lg font-semibold py-3 border-b-4 border-transparent" data-tab="schedule">
                        Programação
                    </button>
                    <button class="tab-button text-lg font-semibold py-3 border-b-4 border-transparent text-gray-400" data-tab="students">
                        Alunos & OKRs
                    </button>
                </nav>
            </div>

            <!-- Conteúdo Abas -->
            <div id="tab-content-schedule" class="tab-content space-y-4">
                <!-- Conteúdo da Programação -->
            </div>

            <div id="tab-content-students" class="tab-content hidden">
                <button id="show-add-student-modal" class="mb-6 bg-lakers-gold text-lakers-purple-darker font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-lakers-gold-light transition flex items-center space-x-2">
                    <span class="font-bold text-xl mr-1">+</span>
                    <span>Adicionar Aluno</span>
                </button>
                <!-- Este container agora terá uma GRADE de cards de alunos -->
                <div id="students-okr-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- Cards de Alunos serão injetados aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Ver OKRs do Aluno (Nível 3) -->
    <div id="student-okr-modal" class="modal">
        <div class="modal-content bg-lakers-purple-dark w-11/12 md:max-w-3xl m-auto mt-12 p-6 rounded-xl shadow-2xl border border-lakers-purple overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 id="student-okr-title" class="text-3xl font-bold text-white"></h2>
                    <p id="student-okr-role" class="text-xl text-lakers-gold-light"></p>
                </div>
                <button id="close-student-okr" class="text-gray-400 hover:text-white transition text-3xl font-bold">&times;</button>
            </div>
            
            <!-- Hidden inputs to store context -->
            <input type="hidden" id="student-okr-class-id">
            <input type="hidden" id="student-okr-student-id">

            <!-- Container for autonomy and OKRs -->
            <div id="student-okr-content-container">
                <!-- Conteúdo (Autonomia e OKRs) será injetado aqui pelo JS -->
            </div>
        </div>
    </div>


    <!-- Script principal -->
    <script type="module">
        // --- Configuração do LocalStorage ---
        const STORAGE_KEY = 'onboardingAppClasses';
        let localState = {
            classes: []
        };

        // --- Elementos do DOM ---
        const classesContainer = document.getElementById('classes-container');
        const noClassesMessage = document.getElementById('no-classes-message');

        const createClassModal = document.getElementById('create-class-modal');
        const showCreateClassModalBtn = document.getElementById('show-create-class-modal');
        const cancelCreateClassBtn = document.getElementById('cancel-create-class');
        const confirmCreateClassBtn = document.getElementById('confirm-create-class');
        const startDateInput = document.getElementById('start-date');

        const addStudentModal = document.getElementById('add-student-modal');
        const showAddStudentModalBtn = document.getElementById('show-add-student-modal');
        const cancelAddStudentBtn = document.getElementById('cancel-add-student');
        const confirmAddStudentBtn = document.getElementById('confirm-add-student');
        const addStudentClassIdInput = document.getElementById('add-student-class-id');
        const studentNameInput = document.getElementById('student-name');
        const studentRoleInput = document.getElementById('student-role');

        const viewClassModal = document.getElementById('view-class-modal');
        const closeViewClassBtn = document.getElementById('close-view-class');
        const viewClassTitle = document.getElementById('view-class-title');
        const viewClassWeek = document.getElementById('view-class-week');
        const viewClassIdInput = document.getElementById('view-class-id');
        const scheduleTabContent = document.getElementById('tab-content-schedule');
        const studentsTabContent = document.getElementById('tab-content-students');
        const studentsOkrContainer = document.getElementById('students-okr-container');

        // --- Novos Elementos do Modal de OKR Individual ---
        const studentOkrModal = document.getElementById('student-okr-modal');
        const closeStudentOkrBtn = document.getElementById('close-student-okr');
        const studentOkrTitle = document.getElementById('student-okr-title');
        const studentOkrRole = document.getElementById('student-okr-role');
        const studentOkrClassIdInput = document.getElementById('student-okr-class-id');
        const studentOkrStudentIdInput = document.getElementById('student-okr-student-id');
        const studentOkrContentContainer = document.getElementById('student-okr-content-container');

        // --- Funções Auxiliares de Data ---

        /** Formata um objeto Date para dd/MM/yyyy */
        function formatDate(date) {
            if (!date) return 'Data Inválida';
            
            // A data que é passada (criada com T12:00:00) já está no dia local correto,
            // pois new Date("YYYY-MM-DDT12:00:00") é interpretado como local.
            // O uso de timeZone: 'UTC' + 12h estava causando o pulo de dia.
            // Apenas formatar para pt-BR (que usará o fuso local) é o correto.
            return date.toLocaleDateString('pt-BR');
        }
        
        /** Formata um objeto Date para yyyy-MM-dd (formato ISO) mas mantendo a data LOCAL */
        function formatToISODate(date) {
            // return date.toISOString().split('T')[0]; // ISSO CAUSA BUGS DE TIMEZONE
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /** Adiciona dias a uma data */
        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        /** Encontra o próximo dia útil (Seg-Sex) */
        function getNextWorkingDay(date) {
            const nextDay = new Date(date.getTime());
            do {
                nextDay.setDate(nextDay.getDate() + 1);
            } while (nextDay.getDay() === 0 || nextDay.getDay() === 6); // 0 = Domingo, 6 = Sábado
            return nextDay;
        }

        /** Encontra a próxima Segunda-Feira */
        function getNextMonday(date) {
            const nextDay = new Date(date.getTime());
            nextDay.setDate(nextDay.getDate() + 1); // Começa do dia seguinte
            while (nextDay.getDay() !== 1) { // 1 = Segunda
                nextDay.setDate(nextDay.getDate() + 1);
            }
            return nextDay;
        }

        /** Gera a programação completa e as datas de início das semanas */
        function generateScheduleAndWeeks(startDateString) {
            // Garante que a data seja interpretada como local
            const [year, month, day] = startDateString.split('-').map(Number);
            const d0 = new Date(year, month - 1, day);

            const d1 = getNextWorkingDay(d0);
            const d2 = getNextWorkingDay(d1);
            const d3 = getNextWorkingDay(d2);
            const d4 = getNextWorkingDay(d3); // Fim da Semana 1 (Programação)

            const schedule = [
                { date: formatToISODate(d0), tasks: ["Apresentar onboarding técnico", "Member Kit - Introdução ao Marketplace"] },
                { date: formatToISODate(d1), tasks: ["Member Kit - Nossos serviços", "Member Kit - Rampagem Performance", "Inicio / reapresentação Shark Tank"] },
                { date: formatToISODate(d2), tasks: ["Assistir Todas formações: Growth, Analytics, Assessor"] },
                { date: formatToISODate(d3), tasks: ["Assistir videos mamba academy", "Ler Metodologia", "1:1 Com todos"] },
                { date: formatToISODate(d4), tasks: ["AVALIAÇÃO DE FORMAÇÃO"] }
            ];

            // Calcula inícios das semanas
            const startOfWeek2 = getNextMonday(d4);
            const startOfWeek3 = addDays(startOfWeek2, 7);
            const fridayOfWeek3 = addDays(startOfWeek3, 4); // Sexta da Semana 3
            const startOfWeek4 = addDays(startOfWeek3, 7);
            const startOfWeek5 = addDays(startOfWeek4, 7); // Data de "Completo"

            const weekStartDates = {
                startOfWeek1: formatToISODate(d0),
                startOfWeek2: formatToISODate(startOfWeek2),
                startOfWeek3: formatToISODate(startOfWeek3),
                fridayOfWeek3: formatToISODate(fridayOfWeek3),
                startOfWeek4: formatToISODate(startOfWeek4),
                startOfWeek5: formatToISODate(startOfWeek5),
            };

            return { schedule, weekStartDates };
        }

        /** Calcula a semana atual com base nas datas */
        function getCurrentWeekInfo(weekStartDates) {
            if (!weekStartDates || !weekStartDates.startOfWeek1) {
                return { text: "Semana Indefinida", weekNumber: 0 };
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0); // Zera a hora para comparação

            // Converte strings ISO para objetos Date (interpretando como UTC para evitar timezone shift)
            const w1 = new Date(weekStartDates.startOfWeek1 + 'T00:00:00Z');
            const w2 = new Date(weekStartDates.startOfWeek2 + 'T00:00:00Z');
            const w3 = new Date(weekStartDates.startOfWeek3 + 'T00:00:00Z');
            const w4 = new Date(weekStartDates.startOfWeek4 + 'T00:00:00Z');
            const w5 = new Date(weekStartDates.startOfWeek5 + 'T00:00:00Z');

            if (today >= w5) return { text: "Onboarding Técnico Completo", weekNumber: 5 };
            if (today >= w4) return { text: "Semana 4", weekNumber: 4 };
            if (today >= w3) return { text: "Semana 3", weekNumber: 3 };
            if (today >= w2) return { text: "Semana 2", weekNumber: 2 };
            return { text: "Semana 1 (Programação)", weekNumber: 1 };
        }


        // --- Funções de Armazenamento Local ---

        /** Salva o estado atual no localStorage */
        function saveClassesToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(localState.classes));
        }

        /** Carrega as turmas do localStorage */
        function loadClasses() {
            const classesFromStorage = localStorage.getItem(STORAGE_KEY);
            if (classesFromStorage) {
                localState.classes = JSON.parse(classesFromStorage);
            } else {
                localState.classes = [];
            }
            
            // Ordena as turmas pela data de início mais recente
            localState.classes.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
            
            renderClasses();
        }

        /** Cria uma nova turma */
        function createClass(startDate) {
            if (!startDate) {
                alert("Por favor, selecione uma data de início.");
                return;
            }

            try {
                const { schedule, weekStartDates } = generateScheduleAndWeeks(startDate);
                const newClass = {
                    id: crypto.randomUUID(), // Gera um ID único
                    startDate: startDate,
                    schedule: schedule,
                    weekStartDates: weekStartDates,
                    students: []
                };
                
                localState.classes.push(newClass);
                saveClassesToStorage();
                renderClasses(); // Atualiza a visualização principal
                closeModal(createClassModal);

            } catch (error) {
                console.error("Erro ao criar turma: ", error);
            }
        }

        /** Adiciona um aluno a uma turma */
        function addStudent(classId, name, role) {
            if (!name || !role) {
                alert("Por favor, preencha o nome e a função do aluno.");
                return;
            }

            const classIndex = localState.classes.findIndex(c => c.id === classId);
            if (classIndex === -1) return;

            const newStudent = {
                id: crypto.randomUUID(),
                name: name,
                role: role,
                autonomy: 'Autonomia Parcial',
                okrs: {
                    week2_memberKit: false,
                    week2_aprovacao: false,
                    week2_dones: false,
                    week3_dones: false,
                    week3_1on1: false, // Tarefa especial da Semana 3
                    week4_dones: false,
                    week4_sharkTank: false
                }
            };
            
            const classData = localState.classes[classIndex];
            const updatedStudents = [...classData.students, newStudent];
            localState.classes[classIndex].students = updatedStudents;
            
            saveClassesToStorage();
            closeModal(addStudentModal);
            openViewModal(classId, 'students'); // Reabre o modal com dados atualizados

        }
        
        /** Atualiza um dado de um aluno (OKR ou Autonomia) */
        function updateStudentData(classId, studentId, key, value) {
            const classIndex = localState.classes.findIndex(c => c.id === classId);
            if (classIndex === -1) return;

            const classData = localState.classes[classIndex];

            const updatedStudents = classData.students.map(student => {
                if (student.id === studentId) {
                    if (key === 'autonomy') {
                        return { ...student, autonomy: value };
                    } else {
                        // Atualiza o OKR específico
                        const updatedOkrs = { ...student.okrs, [key]: value };
                        return { ...student, okrs: updatedOkrs };
                    }
                }
                return student;
            });
            
            localState.classes[classIndex].students = updatedStudents;
            saveClassesToStorage();

            // Atualiza o modal se estiver aberto
            if (viewClassModal.style.display === 'block' && viewClassIdInput.value === classId) {
                 const updatedClassData = localState.classes.find(c => c.id === classId);
                 renderStudentCards(updatedClassData, classId); // Re-renderiza a grid de cards
            }

            // Atualiza o modal DE OKR INDIVIDUAL se estiver aberto (caso a autonomia mude)
            if (studentOkrModal.style.display === 'block' && 
                studentOkrClassIdInput.value === classId &&
                studentOkrStudentIdInput.value === studentId &&
                key === 'autonomy') {
                
                openStudentOkrModal(classId, studentId); // Reabre para refletir
            }
        }

        /** Exclui um aluno */
        function deleteStudent(classId, studentId) {
            if (!confirm("Tem certeza que deseja excluir este aluno?")) return;

            const classIndex = localState.classes.findIndex(c => c.id === classId);
            if (classIndex === -1) return;

            const classData = localState.classes[classIndex];
            const updatedStudents = classData.students.filter(student => student.id !== studentId);
            
            localState.classes[classIndex].students = updatedStudents;
            saveClassesToStorage();
            
            // Atualiza a visualização da turma (que agora mostra os cards)
            const updatedClassData = localState.classes[classIndex];
            renderStudentCards(updatedClassData, classId);
            
            // Atualiza a contagem de alunos no card principal
            renderClasses();
        }
        
        /** Exclui uma turma */
        function deleteClass(classId) {
            if (!confirm("Tem certeza que deseja excluir esta turma? Esta ação é irreversível.")) return;

            localState.classes = localState.classes.filter(c => c.id !== classId);
            saveClassesToStorage();
            renderClasses(); // Atualiza a visualização principal
        }

        // --- Funções de Renderização ---

        /** Renderiza todos os cards de turmas */
        function renderClasses() {
            classesContainer.innerHTML = ''; // Limpa o container
            if (localState.classes.length === 0) {
                noClassesMessage.style.display = 'block';
                return;
            }

            noClassesMessage.style.display = 'none';
            
            localState.classes.forEach(classData => {
                const card = document.createElement('div');
                card.className = 'bg-lakers-purple rounded-xl shadow-lg p-6 border border-lakers-purple-dark hover:shadow-2xl hover:border-lakers-gold transition-all duration-300 transform hover:-translate-y-1';
                
                const weekInfo = getCurrentWeekInfo(classData.weekStartDates);
                let weekColor = 'text-lakers-gold-light';
                if (weekInfo.weekNumber === 5) {
                    weekColor = 'text-green-400';
                }

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-2xl font-bold text-white">Turma de ${formatDate(new Date(classData.startDate + 'T12:00:00'))}</h3>
                            <p class="${weekColor} text-lg font-semibold mt-1">${weekInfo.text}</p>
                        </div>
                        <span class="flex items-center text-white bg-lakers-purple-dark px-3 py-1 rounded-full text-sm font-medium">
                            Alunos: <span class="font-bold ml-1.5">${classData.students.length}</span>
                        </span>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button data-action="delete" data-id="${classData.id}" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-500 transition">
                            Excluir
                        </button>
                        <button data-action="view" data-id="${classData.id}" class="bg-lakers-gold text-lakers-purple-darker font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-lakers-gold-light transition">
                            Ver Detalhes
                        </button>
                    </div>
                `;
                classesContainer.appendChild(card);
            });
        }

        /** Abre e preenche o modal de detalhes da turma */
        function openViewModal(classId, defaultTab = 'schedule') {
            const classData = localState.classes.find(c => c.id === classId);
            if (!classData) return;

            viewClassIdInput.value = classId;
            addStudentClassIdInput.value = classId;
            viewClassTitle.textContent = `Turma de ${formatDate(new Date(classData.startDate + 'T12:00:00'))}`;
            
            const weekInfo = getCurrentWeekInfo(classData.weekStartDates);
            viewClassWeek.textContent = weekInfo.text;
            viewClassWeek.className = 'text-xl';
            if (weekInfo.weekNumber === 5) {
                viewClassWeek.classList.add('text-green-400');
            } else {
                viewClassWeek.classList.add('text-lakers-gold-light');
            }

            // Renderiza Programação
            const todayISO = formatToISODate(new Date()); // Pega a data de hoje

            scheduleTabContent.innerHTML = classData.schedule.map(day => {
                const isToday = (day.date === todayISO);
                
                // Define classes de destaque
                const highlightClasses = isToday 
                    ? 'border-green-500 border-2 shadow-lg' // Destaque verde para o dia atual
                    : 'border-lakers-purple border'; // Borda padrão para melhor divisão

                return `
                    <div class="bg-lakers-purple-dark rounded-lg p-4 ${highlightClasses} transition-all">
                        <h4 class="text-lg font-semibold ${isToday ? 'text-green-400' : 'text-lakers-gold'}">
                            ${formatDate(new Date(day.date + 'T12:00:00'))} ${isToday ? '(Hoje)' : ''}
                        </h4>
                        <ul class="list-disc list-inside text-white mt-2 space-y-1">
                            ${day.tasks.map(task => `<li>${task}</li>`).join('')}
                        </ul>
                    </div>
                `
            }).join('');
            
            // Renderiza Alunos
            renderStudentCards(classData, classId);

            // Abre o modal e a aba correta
            switchTab(defaultTab);
            openModal(viewClassModal);
        }
        
        /** Renderiza a lista de cards de alunos no modal de turma */
        function renderStudentCards(classData, classId) {
            studentsOkrContainer.innerHTML = ''; // Limpa
            
            if(classData.students.length === 0) {
                studentsOkrContainer.className = ''; // Reseta o grid
                studentsOkrContainer.innerHTML = `<p class="text-gray-400 text-center">Nenhum aluno adicionado a esta turma.</p>`;
                return;
            }
            
            // Define o container como um grid
            studentsOkrContainer.className = 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4';

            classData.students.forEach(student => {
                const studentCard = document.createElement('div');
                // Este é o card clicável
                studentCard.className = 'bg-lakers-purple-dark rounded-lg p-4 relative transition-all duration-200 hover:shadow-lg hover:border-lakers-gold border border-transparent cursor-pointer';
                studentCard.dataset.action = 'view-student-okr';
                studentCard.dataset.studentid = student.id;
                studentCard.dataset.classid = classId;

                studentCard.innerHTML = `
                    <h4 class="text-lg font-bold text-white truncate">${student.name}</h4>
                    <p class="text-lakers-gold-light text-sm truncate">${student.role}</p>
                    
                    <!-- Botão de Excluir (Agora funciona e está posicionado) -->
                    <button data-action="delete-student" data-studentid="${student.id}" data-classid="${classId}" 
                            class="absolute top-2 right-2 text-red-500 hover:text-red-400 p-1 rounded-full hover:bg-lakers-purple text-xs font-semibold transition">
                        Excluir
                    </button>
                `;
                studentsOkrContainer.appendChild(studentCard);
            });
        }

        /** Abre e preenche o modal de OKRs de um aluno específico */
        function openStudentOkrModal(classId, studentId) {
            const classData = localState.classes.find(c => c.id === classId);
            if (!classData) return;
            
            const student = classData.students.find(s => s.id === studentId);
            if (!student) return;

            const weekInfo = getCurrentWeekInfo(classData.weekStartDates);

            // Preenche o modal
            studentOkrTitle.textContent = student.name;
            studentOkrRole.textContent = student.role;
            studentOkrClassIdInput.value = classId;
            studentOkrStudentIdInput.value = studentId;

            // Renderiza o conteúdo (autonomia + OKRs)
            studentOkrContentContainer.innerHTML = `
                <div class="flex items-center justify-between mb-6 bg-lakers-purple p-4 rounded-lg">
                    <label for="autonomy-${student.id}" class="block text-lg font-medium">Autonomia</label>
                    <select id="autonomy-${student.id}" data-studentid="${student.id}" data-classid="${classId}" class="autonomy-select bg-lakers-purple-dark text-white rounded-lg p-2 border border-lakers-gold focus:outline-none focus:ring-2 focus:ring-lakers-gold">
                        <option value="Autonomia Parcial" ${student.autonomy === 'Autonomia Parcial' ? 'selected' : ''}>Parcial</option>
                        <option value="Autonomia Completa" ${student.autonomy === 'Autonomia Completa' ? 'selected' : ''}>Completa</option>
                    </select>
                </div>
                
                <!-- OKRs -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    ${renderOkrSection("Semana 2", [
                        { key: 'week2_memberKit', label: 'Finalização do Member Kit', checked: student.okrs.week2_memberKit },
                        { key: 'week2_aprovacao', label: 'Aprovação na Formação', checked: student.okrs.week2_aprovacao },
                        { key: 'week2_dones', label: '5 Dones completos (Semana)', checked: student.okrs.week2_dones },
                    ], student.id, classId, weekInfo.weekNumber >= 2, weekInfo.weekNumber === 2)}
                    
                    ${renderOkrSection("Semana 3", [
                        { key: 'week3_dones', label: '10 Dones Completos', checked: student.okrs.week3_dones },
                        { key: 'week3_1on1', label: '1:1 LÍDER + BUDDY (Sexta)', checked: student.okrs.week3_1on1 },
                    ], student.id, classId, weekInfo.weekNumber >= 3, weekInfo.weekNumber === 3)}

                    ${renderOkrSection("Semana 4", [
                        { key: 'week4_dones', label: '15 Dones completos', checked: student.okrs.week4_dones },
                        { key: 'week4_sharkTank', label: 'Aprovação no Shark Tank', checked: student.okrs.week4_sharkTank },
                    ], student.id, classId, weekInfo.weekNumber >= 4, weekInfo.weekNumber === 4)}
                </div>
            `;
            
            openModal(studentOkrModal);
        }

        /** Função auxiliar para renderizar uma seção de OKR */
        function renderOkrSection(title, okrs, studentId, classId, isActive, isCurrentWeek = false) {
            const opacityClass = isActive ? 'opacity-100' : 'opacity-40';
            
            let titleColor = 'text-gray-500'; // Cor padrão (desativado/passado)
            if (isCurrentWeek) {
                titleColor = 'text-green-400'; // Cor da semana atual
            } else if (isActive) {
                titleColor = 'text-lakers-gold'; // Cor de semana futura (ativa)
            }

            const borderClass = isCurrentWeek ? 'border-green-500 border-2' : 'border-transparent'; // Borda para semana atual
            
            return `
                <div class="bg-lakers-purple-darker p-4 rounded-lg ${opacityClass} ${borderClass} transition-all">
                    <h5 class="${titleColor} text-lg font-semibold mb-3">
                        ${title} ${isCurrentWeek ? '(Semana Atual)' : ''}
                    </h5>
                    <div class="space-y-3">
                        ${okrs.map(okr => `
                            <label class="flex items-center text-white cursor-pointer">
                                <input type="checkbox" 
                                       data-okrkey="${okr.key}" 
                                       data-studentid="${studentId}" 
                                       data-classid="${classId}"
                                       class="okr-checkbox h-5 w-5 rounded bg-lakers-purple border-lakers-gold text-lakers-gold focus:ring-lakers-gold"
                                       ${okr.checked ? 'checked' : ''}
                                       ${!isActive ? 'disabled' : ''}>
                                <span class="ml-3">${okr.label}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
        }


        // --- Funções de Modal ---
        function openModal(modal) {
            modal.style.display = 'block';
        }
        function closeModal(modal) {
            modal.style.display = 'none';
        }
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active', 'text-lakers-gold'));
            
            document.getElementById(`tab-content-${tabName}`).style.display = 'block';
            document.querySelector(`.tab-button[data-tab="${tabName}"]`).classList.add('active', 'text-lakers-gold');
            document.querySelector(`.tab-button[data-tab="${tabName}"]`).classList.remove('text-gray-400');
        }


        // --- Event Listeners ---
        function setupEventListeners() {
            // Abrir modal de criar turma
            showCreateClassModalBtn.addEventListener('click', () => {
                startDateInput.valueAsDate = new Date(); // Define a data de hoje
                openModal(createClassModal);
            });
            
            // Fechar modais
            cancelCreateClassBtn.addEventListener('click', () => closeModal(createClassModal));
            cancelAddStudentBtn.addEventListener('click', () => closeModal(addStudentModal));
            closeViewClassBtn.addEventListener('click', () => closeModal(viewClassModal));
            closeStudentOkrBtn.addEventListener('click', () => closeModal(studentOkrModal)); // Fechar novo modal
            
            // Ações principais
            confirmCreateClassBtn.addEventListener('click', () => {
                createClass(startDateInput.value);
            });
            
            confirmAddStudentBtn.addEventListener('click', () => {
                addStudent(
                    addStudentClassIdInput.value,
                    studentNameInput.value,
                    studentRoleInput.value
                );
                // Limpa os campos
                studentNameInput.value = '';
                studentRoleInput.value = '';
            });

            // Abrir modal de adicionar aluno (de dentro do modal de turma)
            showAddStudentModalBtn.addEventListener('click', () => {
                // O classId já está no input hidden `add-student-class-id`
                openModal(addStudentModal);
            });

            // Delegação de eventos no container de turmas
            classesContainer.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                const action = button.dataset.action;
                const id = button.dataset.id;

                if (action === 'view') {
                    openViewModal(id);
                }
                if (action === 'delete') {
                    deleteClass(id);
                }
            });

            // Delegação de eventos no container de cards de aluno (substitui o listener antigo)
            studentsOkrContainer.addEventListener('click', (e) => {
                const target = e.target;
                
                // Botão Excluir
                const deleteButton = target.closest('[data-action="delete-student"]');
                if (deleteButton) {
                    e.stopPropagation(); // Impede o card de ser clicado
                    const { studentid, classid } = deleteButton.dataset;
                    deleteStudent(classid, studentid);
                    return;
                }

                // Card Clicável para ver OKRs
                const card = target.closest('[data-action="view-student-okr"]');
                if (card) {
                    const { studentid, classid } = card.dataset;
                    openStudentOkrModal(classid, studentid);
                }
            });

            // NOVO LISTENER: Delegação de eventos no modal DE OKR INDIVIDUAL
            studentOkrModal.addEventListener('change', (e) => {
                const target = e.target;
                // Pega o contexto dos inputs hidden
                const classId = studentOkrClassIdInput.value;
                const studentId = studentOkrStudentIdInput.value;

                if (!classId || !studentId) return;

                // Checkbox de OKR
                if (target.classList.contains('okr-checkbox')) {
                    const { okrkey } = target.dataset;
                    updateStudentData(classId, studentId, okrkey, target.checked);
                }
                
                // Select de Autonomia
                if (target.classList.contains('autonomy-select')) {
                    updateStudentData(classId, studentId, 'autonomy', target.value);
                }
            });


            // Troca de Abas
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    switchTab(button.dataset.tab);
                });
            });

            // Fechar modal clicando fora
            window.addEventListener('click', (e) => {
                if (e.target === createClassModal) closeModal(createClassModal);
                if (e.target === addStudentModal) closeModal(addStudentModal);
                if (e.target === viewClassModal) closeModal(viewClassModal);
                if (e.target === studentOkrModal) closeModal(studentOkrModal); // Fechar novo modal
            });
        }
        
        // --- Inicialização ---
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            loadClasses(); // Carrega os dados do localStorage ao iniciar
        });

    </script>
</body>
</html>





